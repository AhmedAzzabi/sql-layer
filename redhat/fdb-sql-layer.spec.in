%define __jar_repack %{nil}

%global username foundationdb-sql

%define relname %{name}-%{version}-%{release}

Name:           fdb-sql-layer
Version:        2.0.0
Release:        _GIT_COUNT%{?dist}
Epoch:          _EPOCH
Summary:        FoundationDB SQL Layer

Group:          Applications/Databases
License:        AGPL
URL:            http://foundationdb.com

Source0:       fdbsql.tar.gz
BuildRoot:     %{_tmppath}/%{name}-%{version}-%{release}-root

Requires:      jre >= 1.7.0
Requires(pre): user(foundationdb-sql)
Requires(pre): group(foundationdb-sql)
Requires(pre): shadow-utils
Provides:      user(foundationdb-sql)
Provides:      group(foundationdb-sql)

BuildArch:      noarch
BuildRequires:  jdk >= 1.7.0

%description
FoundationDB SQL Layer

For more information see http://foundationdb.com

%prep
%setup -q -n fdbsql

%build
mvn -B clean install -DGIT_COUNT=_GIT_COUNT -DGIT_HASH=_GIT_HASH -DskipTests=true

%install
rm -rf ${RPM_BUILD_ROOT}
mkdir -p ${RPM_BUILD_ROOT}%{_sysconfdir}/%{username}/
mkdir -p ${RPM_BUILD_ROOT}/usr/share/%{username}/server
mkdir -p ${RPM_BUILD_ROOT}/usr/share/%{username}/client
mkdir -p ${RPM_BUILD_ROOT}/etc/%{username}/config
mkdir -p ${RPM_BUILD_ROOT}/etc/rc.d/init.d/
mkdir -p ${RPM_BUILD_ROOT}/etc/security/limits.d/
mkdir -p ${RPM_BUILD_ROOT}/etc/default/
mkdir -p ${RPM_BUILD_ROOT}/usr/sbin
mkdir -p ${RPM_BUILD_ROOT}/usr/bin
mkdir -p ${RPM_BUILD_ROOT}/usr/share/%{username}/plugins

cp -p redhat/log4j.properties ${RPM_BUILD_ROOT}/etc/%{username}/config
cp -p redhat/server.properties ${RPM_BUILD_ROOT}/etc/%{username}/config
cp -p redhat/services-config.yaml ${RPM_BUILD_ROOT}/etc/%{username}/config
cp -p redhat/jvm.options ${RPM_BUILD_ROOT}/etc/%{username}/config
cp -p redhat/fdb-sql-layer ${RPM_BUILD_ROOT}/etc/rc.d/init.d/
cp -p redhat/LICENSE.txt ${RPM_BUILD_ROOT}/usr/share/%{username}

cp -p target/foundationdb-sql-layer-2.0.0-SNAPSHOT.jar ${RPM_BUILD_ROOT}/usr/share/%{username}
ln -s /usr/share/%{username}/foundationdb-sql-layer-2.0.0-SNAPSHOT.jar ${RPM_BUILD_ROOT}/usr/share/%{username}/foundationdb-sql-layer.jar
cp -p target/dependency/* ${RPM_BUILD_ROOT}/usr/share/%{username}/server
cp -p redhat/foundationdb-sql-layer-client-tools-1.3.7-SNAPSHOT.jar ${RPM_BUILD_ROOT}/usr/share/%{username}
ln -s /usr/share/%{username}/foundationdb-sql-layer-client-tools-1.3.7-SNAPSHOT.jar ${RPM_BUILD_ROOT}/usr/share/%{username}/foundationdb-sql-layer-client-tools.jar
cp -p redhat/client/* ${RPM_BUILD_ROOT}/usr/share/%{username}/client
cp -pR redhat/plugins/ ${RPM_BUILD_ROOT}/usr/share/%{username}/

mv redhat/fdbsql* ${RPM_BUILD_ROOT}/usr/bin
mv bin/fdbsqllayer ${RPM_BUILD_ROOT}/usr/sbin

mkdir -p ${RPM_BUILD_ROOT}/var/lib/%{username}
mkdir -p ${RPM_BUILD_ROOT}/var/lib/%{username}
mkdir -p ${RPM_BUILD_ROOT}/var/lib/%{username}
mkdir -p ${RPM_BUILD_ROOT}/var/run/%{username}
mkdir -p ${RPM_BUILD_ROOT}/var/log/%{username}

%clean
rm -rf ${RPM_BUILD_ROOT}

%pre
getent group %{username} >/dev/null || groupadd -r %{username}
getent passwd %{username} >/dev/null || \
useradd -d /usr/share/%{username} -g %{username} -M -r %{username}
exit 0

%preun
# only delete user on removal, not upgrade
if [ "$1" = "0" ]; then
    userdel %{username}
fi

%files
%defattr(-,root,root,0755)
%attr(755,root,root) %{_sbindir}/fdbsqllayer
%attr(755,root,root) %{_bindir}/fdbsql*
%attr(755,root,root) /etc/rc.d/init.d/fdb-sql-layer
%attr(755,%{username},%{username}) /usr/share/%{username}*
%attr(755,%{username},%{username}) %config(noreplace) /%{_sysconfdir}/%{username}
%attr(755,%{username},%{username}) %config(noreplace) /var/lib/%{username}
%attr(755,%{username},%{username}) /var/log/%{username}*
%attr(755,%{username},%{username}) /var/run/%{username}*

%post
alternatives --install /etc/%{username}/config %{username} /etc/%{username}/default.conf/ 0
# make fdb-sql-layer start/shutdown automatically
if [ -x /sbin/chkconfig ]; then
    /sbin/chkconfig --add fdb-sql-layer
fi
exit 0

%postun
# only delete alternative on removal, not upgrade
if [ "$1" = "0" ]; then
    # stop fdb-sql-layer before uninstalling it
    if [ -x %{_sysconfdir}/init.d/fdb-sql-layer ]; then
        %{_sysconfdir}/init.d/fdb-sql-layer stop > /dev/null
        # don't start it automatically anymore
        if [ -x /sbin/chkconfig ]; then
            /sbin/chkconfig --del fdb-sql-layer
        fi
    fi
    alternatives --remove %{username} /etc/%{username}/default.conf/
fi
exit 0
