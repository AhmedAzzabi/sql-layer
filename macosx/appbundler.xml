<?xml version="1.0" encoding="UTF-8"?>
<project name="Akiban Server App Builder" default="usage" basedir="..">
    <!--
         Orace and appbundler docs:
         http://docs.oracle.com/javase/7/docs/technotes/guides/jweb/packagingAppsForMac.html
         http://java.net/downloads/appbundler/appbundler.html
    -->

    <macrodef name="bundle_macro">
        <element name="some-tasks" optional="yes" />
        <sequential>
            <taskdef name="bundleapp"
                     classname="com.oracle.appbundler.AppBundlerTask"
                     classpath="target/appbundler-1.0.jar" />
            
            <fail unless="akserver.version" message="akserver.version property required" />
            <fail unless="jdk.home" message="jdk.home property required" />

            <!-- All attributes, except outputdirectory, correspond to Info.plist entires -->
            <bundleapp outputdirectory="target/" 
                       name="Akiban Server"
                       displayname="Akiban Server"
                       identifier="com.akiban.server"
                       icon="macosx/Akiban Server.icns"
                       shortversion="${akserver.version}"
                       signature="????"
                       copyright="Â© 2009-2013 Akiban Technologies, Inc."
                       applicationCategory="public.app-category.developer-tools"
                       mainclassname="com.akiban.server.service.ui.AkServerWithSwingConsole">

                <!-- Include the compile time JRE in the bundle. Adds ~135M. -->
                <some-tasks />

                <!-- Files are copied into bundle and set as classpath -->
                <classpath dir="target/">
                    <include name="akiban-server-*.jar" />
                    <include name="dependency/*.jar" />
                </classpath>
                
                <!-- option-s are passed to the JVM -->
                <option value="-ea" />
                
                <option value="-XX:+UseThreadPriorities" />
                <option value="-XX:ThreadPriorityPolicy=42" />
                <option value="-Xms1024m" />
                <option value="-Xmx1024m" />
                <option value="-XX:+UseParNewGC" />

                <option value="-Dcom.sun.management.jmxremote.port=8082" />
                <option value="-Dcom.sun.management.jmxremote.ssl=false" />
                <option value="-Dcom.sun.management.jmxremote.authenticate=false" />

                <!--
                <option value="-XX:+HeapDumpOnOutOfMemoryError" />
                <option value="-Xrunjdwp:transport=dt_socket,address=8000,suspend=n,server=y" />
                <option value="-Djava.net.preferIPv4Stack=true" />
                -->
                
                <option value="-Dapple.laf.useScreenMenuBar=true" />
                <option value="-Dlog4j.configuration=file:$APP_ROOT/Contents/Resources/config/log4j.properties" />
                <option value="-Dakserver.config_dir=$APP_ROOT/Contents/Resources" />
                <option value="-Dservices.config=$APP_ROOT/Contents/Resources/config/services-config.yaml" />
                <option value="-Dakiban.home=$APP_ROOT/Contents/Resources" />

                <!-- The displayname should influence the About menu but doesn't. This does. -->
                <option value="-Xdock:name=Akiban Server" />
            </bundleapp>
        </sequential>
    </macrodef>

    <target name="usage">
        <fail message="Call with target bundle_no_jre or bundle_with_jre" />
    </target>
    
    <target name="bundle_app">
        <bundle_macro />
    </target>

    <target name="bundle_app_embed_jre">
        <bundle_macro>
            <some-tasks>
                <runtime dir="${jdk.home}" />
            </some-tasks>
        </bundle_macro>
    </target>

</project>
