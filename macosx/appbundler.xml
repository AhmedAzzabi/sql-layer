<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright (C) 2009-2013 FoundationDB, LLC

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->
<project name="FoundationDB SQL Layer App Builder" default="usage" basedir="..">
    <!--
         Oracle and appbundler docs:
         http://docs.oracle.com/javase/7/docs/technotes/guides/jweb/packagingAppsForMac.html
         http://java.net/downloads/appbundler/appbundler.html
    -->
    <macrodef name="bundle_macro">
        <element name="extra-tasks" optional="true" />
        <sequential>
            <taskdef name="bundleapp"
                     classname="com.oracle.appbundler.AppBundlerTask"
                     classpath="target/appbundler-1.0.jar" />
            
            <fail unless="fdbsql.version" message="fdbsql.version property required" />
            <fail unless="jdk.home" message="jdk.home property required" />

            <!-- All attributes, except outputdirectory, correspond to Info.plist entires -->
            <bundleapp outputdirectory="target/" 
                       name="FoundationDB SQL Layer"
                       displayname="FoundationDB SQL Layer"
                       identifier="com.foundationdb.sql"
                       icon="macosx/Akiban Server.icns"
                       shortversion="${fdbsql.version}"
                       signature="????"
                       copyright="Â© 2009-2013 FoundationDB, LLC"
                       applicationCategory="public.app-category.developer-tools"
                       mainclassname="com.foundationdb.sql.ui.MainWithSwingConsole">
                
                <extra-tasks />

                <!-- Files are copied into bundle and set as classpath -->
                <classpath dir="target/">
                    <include name="fdb-sql-layer-*.jar" />
                    <include name="dependency/*.jar" />
                </classpath>
                
                <!-- option-s are passed to the JVM -->
                <option value="-ea" />
                
                <option value="-XX:+UseThreadPriorities" />
                <option value="-XX:ThreadPriorityPolicy=42" />
                <option value="-Xms1024m" />
                <option value="-Xmx1024m" />
                <option value="-XX:+UseParNewGC" />

                <option value="-Dcom.sun.management.jmxremote.port=8082" />
                <option value="-Dcom.sun.management.jmxremote.ssl=false" />
                <option value="-Dcom.sun.management.jmxremote.authenticate=false" />

                <!--
                <option value="-XX:+HeapDumpOnOutOfMemoryError" />
                <option value="-Xrunjdwp:transport=dt_socket,address=8000,suspend=n,server=y" />
                <option value="-Djava.net.preferIPv4Stack=true" />
                -->
                
                <option value="-Dapple.laf.useScreenMenuBar=true" />
                <option value="-Dlog4j.configuration=file:$APP_ROOT/Contents/Resources/config/log4j.properties" />
                <option value="-Dfdbsql.config_dir=$APP_ROOT/Contents/Resources/config" />
                <option value="-Dfdbsql.home=$APP_ROOT/Contents/Resources" />

                <!-- The displayname should influence the About menu but doesn't. This does. -->
                <option value="-Xdock:name=FoundationDB SQL Layer" />
            </bundleapp>
        </sequential>
    </macrodef>

    <target name="usage">
        <fail message="Call with target bundle_app or bundle_app_jre" />
    </target>
    
    <target name="bundle_app">
        <bundle_macro />
    </target>

    <target name="bundle_app_jre">
        <bundle_macro>
            <extra-tasks>
                <!-- Include the compile time JRE in the bundle. Adds ~135M. -->
                <runtime dir="${jdk.home}" />
            </extra-tasks>
        </bundle_macro>
    </target>

</project>
