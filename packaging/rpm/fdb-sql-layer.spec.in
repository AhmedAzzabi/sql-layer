Name:       fdb-sql-layer
Version:    2.0.0
Release:    _GIT_COUNT%{?dist}
Epoch:      _EPOCH
Group:      Applications/Databases
License:    AGPLv3
URL:        https://foundationdb.com/layers/sql
Packager:   FoundationDB <distribution@foundationdb.com>
Summary:    FoundationDB SQL Layer
Vendor:     FoundationDB

Requires:       jre >= 1.7.0, foundationdb-clients >= 1.0.1
Requires(post): chkconfig >= 0.9, /sbin/service
Requires(pre):  /usr/sbin/useradd, /usr/sbin/groupadd, /usr/bin/getent
BuildArch:      noarch

%description
FoundationDB SQL Layer.


# Don't touch jar files
%define __jar_repack %{nil}

%prep
rm -rf "${RPM_BUILD_ROOT}"
mkdir -p "${RPM_BUILD_ROOT}"
#tar -xzf %{_sourcedir}/fdb-sql-layer.tar.gz -C ${RPM_BUILD_ROOT}

%pre
getent group foundationdb >/dev/null || groupadd -r foundationdb >/dev/null
getent passwd foundationdb >/dev/null || useradd -c "FoundationDB" -g foundationdb -s /bin/false -r -d /var/lib/foundationdb foundationdb >/dev/null
exit 0

%post
if [ $1 -eq 1 ]; then
    /sbin/chkconfig --add fdb-sql-layer
    /sbin/service fdb-sql-layer start &>/dev/null
else
    /sbin/service fdb-sql-layer condrestart &>/dev/null
fi
exit 0

%preun
if [ $1 -eq 0 ]; then
    /sbin/service fdb-sql-layer stop &>/dev/null
    /sbin/chkconfig --del fdb-sql-layer
fi
exit 0

%install
mkdir -p "${RPM_BUILD_ROOT}/var/lib/foundationdb/sql"
mkdir -p "${RPM_BUILD_ROOT}/var/log/foundationdb/sql"
mkdir -p "${RPM_BUILD_ROOT}/usr/share/doc/fdb-sql-layer"

cp -r etc/ "${RPM_BUILD_ROOT}/"
cp -r usr/ "${RPM_BUILD_ROOT}/"

ln -s /usr/share/foundationdb/sql/fdb-sql-layer-2.0.0-SNAPSHOT.jar "${RPM_BUILD_ROOT}/usr/share/foundationdb/sql/fdb-sql-layer.jar"
ln -s /usr/share/foundationdb/sql/fdb-sql-layer-client-tools-1.3.7-SNAPSHOT.jar "${RPM_BUILD_ROOT}/usr/share/foundationdb/sql/fdb-sql-layer-client-tools.jar"

%clean
rm -rf "${RPM_BUILD_ROOT}"

%files
%defattr(-,root,root)
%dir /etc/foundationdb
%config(noreplace) /etc/foundationdb/sql
%doc /usr/share/doc/fdb-sql-layer
%dir /usr/share/foundationdb
/usr/share/foundationdb/sql/
%attr(700,foundationdb,foundationdb) /var/lib/foundationdb/sql
%attr(700,foundationdb,foundationdb) /var/log/foundationdb/sql
%attr(755,-,-) /etc/rc.d/init.d/fdb-sql-layer
%attr(755,-,-) /usr/bin/fdbsqldump
%attr(755,-,-) /usr/bin/fdbsqlload
%attr(755,-,-) /usr/sbin/fdbsqllayer

