{
"comment" : ["See spec file: ",
    "https://spreadsheets.google.com/a/akiban.com/ccc?key=0AiGr_XWdHm0edFNSaFZwUXd5SnAtOHlDcTJyOEUzdXc",
    "This test plan has a couple modifications from that spec:",
    "   - no orphan rows",
    "   - giving customer id=9 an address"
],

"setup" : {
    "processors_default" : [ "scanrows" ],
    "schema" : "coi",
    "tables" : [
        [ "customer",
            "cid int not null primary key",
            "name varchar(32)",
            "address char(20)"
        ],

        [ "orders",
            "oid int not null primary key",
            "c_id int",
            "when varchar(10)",
            "GROUPING FOREIGN KEY (c_id) REFERENCES customer(cid)",
            "index(when)"
        ],

        [ "item",
            "iid int not null primary key",
            "o_id int",
            "sku int",
            "GROUPING FOREIGN KEY (o_id) REFERENCES orders(oid)"
        ],

        [ "address",
            "aid int not null primary key",
            "c_id int",
            "street varchar(32)",
            "GROUPING FOREIGN KEY (c_id) REFERENCES customer(cid)"
        ]
    ],
    "write_rows" : {
        "customer"  : [ [11, "Alpha", "Mrs"],
                        [19, "Bravo", "Miss"],
                        [18, "Charlie", "Mr"],
                        [30, "Devo", "Akron"],
                        [31, "Elvis", "Chelsea"],
                        [32, "Floyd", "Wall"]
        ],
        "orders"    : [ [21, 11, "1/1/2001"],
                        [22, 11, "2/2/2002"],
                        [23, 18, "2/2/2002"],
                        [300, 30, "3/3/2003"]
        ],
        "item"      : [ [31, 21, 1111],
                        [32, 23, 2222],
                        [3000, 300, 3333]
        ],
        "address"   : [ [41, 11, "500 Harrison"],
                        [42, 19, "1 Akiban Way"],
                        [300, 30, "Ohio"]
        ]
    }
},

"tests" : {
    "from root" : {
        "get"           : "coi:customer:cid=11",
        "expect result" :
        {
            "@customer" :
            [
                {
                    "cid"   : 11,
                    "name"  : "Alpha",
                    "address" : "Mrs",
                    "@orders" :
                    [
                        {
                            "oid"   : 21,
                            "c_id"  : 11,
                            "when"  : "1/1/2001",
                            "@item" : [
                                {
                                    "iid"   : 31,
                                    "o_id"  : 21,
                                    "sku"   : 1111
                                }
                            ]
                        },
                        {
                            "oid"   : 22,
                            "c_id"  : 11,
                            "when"  : "2/2/2002",
                            "@item" : []
                        }
                    ],
                    "@address" :
                    [
                        {
                            "aid"   : 41,
                            "c_id"  : 11,
                            "street": "500 Harrison"
                        }
                    ]
                }
            ]
        }
    },

    "empty result" : {
        "get"           : "coi:customer:cid=999",
        "expect result" : {
            "@customer" : []
        }
    },

    "from child" : {
        "get"           : "coi:orders:oid=21",
        "expect result" :
        {
            "@orders" :
            [
                {
                    "oid"   : 21,
                    "c_id"  : 11,
                    "when"  : "1/1/2001",
                    "@item" : [
                        {
                            "iid"   : 31,
                            "o_id"  : 21,
                            "sku"   : 1111
                        }
                    ]
                }
            ]
        }
    },

    "from predicate's child" : {
        "comment"       : "predicate is on parent",
        "get"           : "coi:orders:(customer)cid=11",
        "expect error"  : "UNSUPPORTED_REQUEST"
    },

    "branched from predicate's parent" : {
        "processors"    : ["scanrows"],
        "get"           : "coi:customer:(orders)oid=21",
        "expect result" :
        {
            "@customer" :
            [
                {
                    "cid" : 11,
                    "address" : "Mrs",
                    "name" : "Alpha",
                    "@orders" :
                    [
                        {
                            "oid" : 21,
                            "c_id" : 11,
                            "when" : "1/1/2001",
                            "@item": [
                                {
                                    "iid" : 31,
                                    "o_id" : 21,
                                    "sku" : 1111
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    },

    "shallow from predicate's parent" : {
        "processors"    : ["scanrows"],
        "get"           : "coi:orders:(item)iid=31",
        "expect result" :
        {
            "@orders" :
            [
                {
                    "oid" : 21,
                    "c_id" : 11,
                    "when" : "1/1/2001",
                    "@item" :
                    [
                        {
                            "iid" : 31,
                            "o_id" : 21,
                            "sku" : 1111
                        }
                    ]
                }
            ]
        }
    },

    "nonunique from predicate's parent" : {
        "processors"    : ["scanrows"],

        "get"           : "coi:customer:(orders)when='2%2F2%2F2002'",
        "expect result" :
        {
            "@customer" :
            [
                {
                    "address" : "Mrs",
                    "cid" : 11,
                    "name" : "Alpha",
                    "@orders" :
                    [
                        {
                            "oid" : 22,
                            "c_id" : 11,
                            "when" : "2/2/2002",
                            "@item" : []
                        }
                    ]
                },
                {
                    "cid" : 18,
                    "name" : "Charlie",
                    "address" : "Mr",
                    "@orders" :
                    [
                        {
                            "oid" : 23,
                            "c_id" : 18,
                            "when" : "2/2/2002",
                            "@item" : [
                                {
                                    "iid" : 32,
                                    "o_id" : 23,
                                    "sku" : 2222
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    },

    "address after item" : {
        "get"           : "coi:customer:cid=30",
        "expect result" :
        {
            "@customer" :
            [
                {
                    "cid"   : 30,
                    "name"  : "Devo",
                    "address" : "Akron",
                    "@orders" :
                    [
                        {
                            "oid"   : 300,
                            "c_id"  : 30,
                            "when"  : "3/3/2003",
                            "@item" : [
                                {
                                    "iid"   : 3000,
                                    "o_id"  : 300,
                                    "sku"   : 3333
                                }
                            ]
                        }
                    ],
                    "@address" :
                    [
                        {
                            "aid"   : 300,
                            "c_id"  : 30,
                            "street": "Ohio"
                        }
                    ]
                }
            ]
        }
    },

    "customer after empty customer" : {
        "get"           : "coi:customer:cid>30",
        "processors" : ["scanrows"],
        "expect result" :
        {
            "@customer" :
            [
                {
                    "cid"   : 31,
                    "name"  : "Elvis",
                    "address" : "Chelsea",
                    "@orders" : [],
                    "@address" : []
                },
                {
                    "cid"   : 32,
                    "name"  : "Floyd",
                    "address" : "Wall",
                    "@orders" : [],
                    "@address" : []
                }
            ]
        }
    }
}

}
