# Test procedures defined as scripts using Akiban Direct extent accessor
---
- Properties: sys-mysql
- suppressed: true
---
- CreateTable: t1 (id INT NOT NULL PRIMARY KEY)
---
- Statement: INSERT INTO t1 VALUES (1), (10), (100), (5), (33), (42);
---
- Statement: >
    CREATE PROCEDURE test_direct(IN n INTEGER, OUT d INTEGER) AS $$
      importPackage(com.akiban.direct);
      var extent = Direct.context.extent;
      var obj = {};
      var i = 0;
      for (var x in Iterator(extent.t1.sort("id"))) {
        if (++i == n) {
          obj.d = x.id;
          break;
        }
      } 
      obj;
    $$ LANGUAGE javascript PARAMETER STYLE variables
---
- Statement: CALL test_direct(2);
- output: [[5]]
---
- Statement: CALL test_direct(3);
- output: [[10]]
---
- Include: all-types-schema.yaml

---
- Statement: INSERT INTO all_types(year_field, boolean_field, numeric_field, double_field, bigint_field, integer_field, date_field, time_field, timestamp_field, varchar_field) VALUES ('2013', 'True', '1','1.5','1','1','2012-01-20', '04:30:10', '2012-01-20 04:30:10', 'Sassafras');
---
- Statement: >
    CREATE PROCEDURE test_all_types(OUT errors VARCHAR(256)) AS $$
      importPackage(com.akiban.direct);
      var extent = Direct.context.extent;
      var obj = {};
      var i = 0;
      obj.errors = "";
      for (var x in Iterator(extent.allTypes)) {
        if (x.yearField != 2013) obj.errors += "year_field,";

        // Fails because we don't actually support a boolean type
        // if (!x.booleanField == true) obj.errors += "boolean_field=" + x.booleanField + ",";

        if (x.numericField != 1) obj.errors += "numeric_field,";
        if (x.doubleField != 1.5) obj.errors += "double_field,";
        if (x.integerField != 1) obj.errors += "integer_field,";
        if (!x.dateField.toString().equals("2012-01-20")) obj.errors += "date_field,";
        
        // Fails -- returns "00:00:00", but I think it is due to a conversion issue in
        // ServerJavaValues where attempt to cast Timestamp as Time yields 0.
        // if (!x.timeField.toString().equals("04:30:10")) obj.errors += "time_field=" + x.timeField + ",";

        if (x.timestampField.toString().equals("2012-01-20 04:30:10")) obj.errors += "timestampField=" + x.timestampField + ",";
        if (!x.varcharField.equals("Sassafras")) obj.errors += "varcharField=" + x.varcharField + ",";
      } 
      obj;
    $$ LANGUAGE javascript PARAMETER STYLE variables
---
- Statement: CALL test_all_types();
- output: [['']]
...
