<project name="Project Helper" basedir="." default="install-cserver">
	<description>Set of ant tasks to install cserver service</description>

	<property name="cserver.install.dir" location="../build/cserver" />
	<property name="mysql.install.dir"   location="../build/mysql" />
	<property name="system.config"       location="../config/default" />






	<property name="system.resources"    location="src/main/resources" />
	<property name="cserver.configdir"    	location="${cserver.install.dir}/etc/akiban" />
	<property name="cserver.logsdir"      	location="${cserver.install.dir}/var/log" />
	<property name="cserver.bindir"      	location="${cserver.install.dir}/usr/local/chunkserver" />
	<property name="cserver.datadir"      	location="${cserver.install.dir}/var/lib/chunkserver" />
	<property name="cserver.rundir"    	location="${cserver.install.dir}/etc/init.d" />
	<property name="cserver.piddir"    	location="${cserver.install.dir}/var/run/" />

    <target name="uninstall-cserver" >
	<delete dir="${cserver.install.dir}" verbose="true"/>
    </target>

    <target name="install-cserver" >

	<property name="cserver.prefix" value="${cserver.install.dir}" />
	<fail unless="cserver.install.dir"    />
	<fail unless="mysql.install.dir"      />
	<fail unless="cserver.prefix"      />
	
	<echo level="info"> Installing cserver in "${cserver.install.dir}" using prefix "${cserver.prefix}" </echo>

	<mkdir dir="${cserver.install.dir}" />	
	<mkdir dir="${cserver.install.dir}/var/lock/subsys" />
	<mkdir dir="${cserver.rundir}" />	
	<mkdir dir="${cserver.bindir}" />	
	<mkdir dir="${cserver.logsdir}" />	
	<mkdir dir="${cserver.configdir}" />	
	<mkdir dir="${cserver.configdir}/config" />	
	<mkdir dir="${cserver.datadir}" />	
	<mkdir dir="${cserver.piddir}" />	
	

	<copy failonerror="true" overwrite="true"
		file="${system.resources}/chunkserverd" 
		todir="${cserver.rundir}" />

	<copy  failonerror="true" overwrite="true"
		file="${system.resources}/bulkload.sh"
		todir="${cserver.bindir}" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/cluster.properties"
		todir="${cserver.configdir}/config" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/log4j.properties" 
		todir="${cserver.configdir}/config" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/chunkserver.properties" 
		todir="${cserver.configdir}/config" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/ais_object_model.xml" 
		todir="${cserver.configdir}/config" />


	<copy file="${basedir}/target/akiban-cserver-0.0.2-SNAPSHOT-jar-with-dependencies.jar" todir="${cserver.bindir}" failonerror="true" overwrite="true" />


	<replace dir="${cserver.rundir}" value="${cserver.prefix}">
	  <include name="**/*"/>
		  <replacetoken>CSERVER.INSTALL.DIR</replacetoken>
	</replace>
	<replace dir="${cserver.rundir}" value="${mysql.install.dir}">
	  <include name="**/*"/>
		  <replacetoken>MYSQL.INSTALL.DIR</replacetoken>
	</replace>

	<replace dir="${cserver.configdir}" value="${cserver.prefix}">
	  <include name="**/*"/>
		  <replacetoken>CSERVER.INSTALL.DIR</replacetoken>
	</replace>
	<replace dir="${cserver.configdir}" value="${mysql.install.dir}">
	  <include name="**/*"/>
		  <replacetoken>MYSQL.INSTALL.DIR</replacetoken>
	</replace>

	<replace dir="${cserver.bindir}" value="${cserver.prefix}">
	  <include name="**/*.sh"/>
		  <replacetoken>CSERVER.INSTALL.DIR</replacetoken>
	</replace>
	<replace dir="${cserver.bindir}" value="${mysql.install.dir}">
	  <include name="**/*.sh"/>
		  <replacetoken>MYSQL.INSTALL.DIR</replacetoken>
	</replace>

	<!-- copy and replace above completely muck up permissions, 
	you need to reset permission on file at the end -->
	<chmod mode="755" file="${cserver.bindir}/bulkload.sh" /> 
	<chmod mode="744" file="${cserver.rundir}/chunkserverd" /> 

    </target>


  <macrodef name="chmod">
       <attribute name="mode"    />
       <attribute name="file"    />
        <sequential>
	        <echo level="info" message="setting mode:@{mode} on file:@{file}"/>
		<exec executable="chmod" failonerror="true">
			<arg value="@{mode}" />
			<arg value="@{file}" />
		</exec>
        </sequential>
    </macrodef>
</project>
