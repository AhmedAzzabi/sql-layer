<project name="Project Helper" basedir="." default="install-cserver">
	<description>Set of ant tasks to install cserver service</description>

	<!--
		Install cserver
		Setup the directory tree for the cserver installation
		
		To run
		ant -f install.xml -Dcserver.install.dir=../build/cserver \
				   -Dmysql.install.dir=../build/mysql     \
				   -Dsystem.config=../config/default
	-->

	<!-- convert a property to absolute location -->
	<property name="cserver.install.path" location="${cserver.install.dir}" />
	<property name="mysql.install.path"   location="${mysql.install.dir}" />

	<property name="cserver.prefix" value="${cserver.install.path}" />

	<fail unless="cserver.install.dir" message="-Dcserver.install.dir is required, add arg -Dcserver.install.dir=../build/cserver" />


	<fail unless="mysql.install.dir"   message="-Dmysql.install.dir is required, add arg -Dmysql.install.dir=../build/mysql" />
	<fail unless="system.config"       message="-Dsystem.config is required, add arg -Dsystem.config=../config/default" />
	<fail unless="cserver.prefix"      />


	<available file="${mysql.install.path}" property="isMysqlInstall" />
	<fail unless="isMysqlInstall" message="dir ${mysql.install.path} does not exist" />

	<available file="${system.config}" property="isSystemConfig" />
	<fail unless="isSystemConfig" message="dir ${system.config} does not exist" />

	<property name="system.resources"    location="src/main/resources" />
	<property name="cserver.configdir"    	location="${cserver.install.path}/etc/akiban" />
	<property name="cserver.logsdir"      	location="${cserver.install.path}/var/log" />
	<property name="cserver.bindir"      	location="${cserver.install.path}/usr/local/chunkserver" />
	<property name="cserver.datadir"      	location="${cserver.install.path}/var/lib/chunkserver" />
	<property name="cserver.rundir"    	location="${cserver.install.path}/etc/init.d" />
	<property name="cserver.piddir"    	location="${cserver.install.path}/var/run/" />


	<echo level="info">
------------------------------------------------------------------
	system.resources    : "${system.resources}"
	system.config       : "${system.config}"
	cserver.install.dir : "${cserver.install.dir}"
	cserver.install.path: "${cserver.install.path}"
	cserver.prefix      : "${cserver.prefix}"
	mysql.install.dir   : "${mysql.install.dir}"
	mysql.install.path  : "${mysql.install.path}"
	cserver.configdir   : "${cserver.configdir}"
	cserver.logsdir     : "${cserver.logsdir}"
	cserver.bindir      : "${cserver.bindir}"
	cserver.datadir     : "${cserver.datadir}"
	cserver.rundir      : "${cserver.rundir}"
	cserver.piddir      : "${cserver.piddir}"
------------------------------------------------------------------
	</echo>



    <target name="uninstall-cserver" >
	<delete dir="${cserver.install.dir}" verbose="true"/>
    </target>

    <target name="install-cserver" >

	
	<mkdir dir="${cserver.install.dir}" />	
	<mkdir dir="${cserver.install.dir}/var/lock/subsys" />
	<mkdir dir="${cserver.rundir}" />	
	<mkdir dir="${cserver.bindir}" />	
	<mkdir dir="${cserver.logsdir}" />	
	<mkdir dir="${cserver.configdir}" />	
	<mkdir dir="${cserver.configdir}/config" />	
	<mkdir dir="${cserver.datadir}" />	
	<mkdir dir="${cserver.piddir}" />	
	

	<copy failonerror="true" overwrite="true"
		file="${system.resources}/chunkserverd" 
		todir="${cserver.rundir}" />

	<copy  failonerror="true" overwrite="true"
		file="${system.resources}/bulkload.sh"
		todir="${cserver.bindir}" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/cluster.properties"
		todir="${cserver.configdir}/config" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/log4j.properties" 
		todir="${cserver.configdir}/config" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/chunkserver.properties" 
		todir="${cserver.configdir}/config" />

	<copy  failonerror="true" overwrite="true"
		file="${system.config}/config/ais_object_model.xml" 
		todir="${cserver.configdir}/config" />


	<copy file="${basedir}/target/akiban-cserver-0.0.2-SNAPSHOT-jar-with-dependencies.jar" todir="${cserver.bindir}" failonerror="true" overwrite="true" />


	<replace dir="${cserver.rundir}" value="${cserver.prefix}">
	  <include name="**/*"/>
		  <replacetoken>CSERVER.INSTALL.DIR</replacetoken>
	</replace>
	<replace dir="${cserver.rundir}" value="${mysql.install.path}">
	  <include name="**/*"/>
		  <replacetoken>MYSQL.INSTALL.DIR</replacetoken>
	</replace>

	<replace dir="${cserver.configdir}" value="${cserver.prefix}">
	  <include name="**/*"/>
		  <replacetoken>CSERVER.INSTALL.DIR</replacetoken>
	</replace>
	<replace dir="${cserver.configdir}" value="${mysql.install.path}">
	  <include name="**/*"/>
		  <replacetoken>MYSQL.INSTALL.DIR</replacetoken>
	</replace>

	<replace dir="${cserver.bindir}" value="${cserver.prefix}">
	  <include name="**/*.sh"/>
		  <replacetoken>CSERVER.INSTALL.DIR</replacetoken>
	</replace>
	<replace dir="${cserver.bindir}" value="${mysql.install.path}">
	  <include name="**/*.sh"/>
		  <replacetoken>MYSQL.INSTALL.DIR</replacetoken>
	</replace>

	<!-- copy and replace above completely muck up permissions, 
	you need to reset permission on file at the end -->
	<chmod mode="755" file="${cserver.bindir}/bulkload.sh" /> 
	<chmod mode="744" file="${cserver.rundir}/chunkserverd" /> 

    </target>


  <macrodef name="chmod">
       <attribute name="mode"    />
       <attribute name="file"    />
        <sequential>
	        <echo level="info" message="setting mode:@{mode} on file:@{file}"/>
		<exec executable="chmod" failonerror="true">
			<arg value="@{mode}" />
			<arg value="@{file}" />
		</exec>
        </sequential>
    </macrodef>
</project>
